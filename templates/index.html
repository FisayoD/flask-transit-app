<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Manhattan Crowd Map</title>

    <!-- Implementing Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <!-- Downloading more fonts to customize -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;700&family=Poppins:wght@300;400;500&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        margin: 0;
        padding: 20px;
      }
      h1 {
        margin-top: 0;
        text-align: center;
        font-family: "Fredoka", "Poppins", sans-serif;
        font-weight: 700;
        font-size: 2.2rem;
      }
      .group-line {
        text-align: center;
        font-size: 0.95rem;
        margin-bottom: 8px;
        font-weight: 400;
      }
      .controls {
        margin-bottom: 10px;
        text-align: center;
        font-size: 0.95rem;
      }
      #map {
        width: 70%;
        max-width: 1100px;
        height: 750px;
        margin: 0 auto;
        border-radius: 80px;
        border: 20px solid #3c65fc;
      }
      label {
        margin-right: 4px;
      }
      select {
        margin-right: 12px;
      }
      button {
        font-family: "Poppins", sans-serif;
      }
    </style>
  </head>

  <body>
    <div class="group-line">
      Group 7 â€“ Dylan Kattou, Alfonso Garcia, Max Kunz, Oluwafisayomi Ojo,
      Sowris Kumar
    </div>

    <h1>Manhattan Crowd Map</h1>

    <div class="controls">
      <label for="date">Date</label>
      <select id="date">
        {% for d in dates %}
        <option value="{{ d }}">{{ d }}</option>
        {% endfor %}
      </select>

      <label for="period">Period</label>
      <select id="period">
        <option value="morning">morning</option>
        <option value="afternoon">afternoon</option>
        <option value="evening">evening</option>
      </select>

      <button id="updateBtn">Update map</button>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // 1. Creating the base map
      var map = L.map("map").setView([40.76, -73.97], 12.8);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      // 2. Here is where I import the GeoJSON layer for taxi zones 
      var zoneLayer = null;
      var geojsonUrl = "/static/nyc_taxi_zones.geojson";

      function colorForCategory(cat) {
        if (cat === "Busy") return "red";
        if (cat === "Moderately Busy") return "orange";
        return "green"; // Not Busy or missing
      }

      // 3. Loading the NYC taxi zones polygons from GeoJSON
      function loadGeojson(callback) {
        fetch(geojsonUrl)
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            // Removing old layers if it exists
            if (zoneLayer) {
              map.removeLayer(zoneLayer);
            }

            // Creating new layer
            zoneLayer = L.geoJSON(data, {
              style: function (feature) {
                var borough =
                  feature.properties.borough || feature.properties.Borough;

                // Sincec the GeoJSON highlights all the buroughs here we highlight only Manhattan and fade other boroughs
                if (borough === "Manhattan") {
                  return {
                    color: "#555",
                    weight: 1,
                    fillColor: "green",
                    fillOpacity: 0.4,
                  };
                } else {
                  return {
                    color: "#999",
                    weight: 1,
                    fillColor: "#dddddd",
                    fillOpacity: 0.08,
                  };
                }
              },
              onEachFeature: function (feature, layer) {
                var zoneName =
                  feature.properties.zone || feature.properties.Zone;
                var borough =
                  feature.properties.borough || feature.properties.Borough;
                var label =
                  (zoneName || "Unknown zone") +
                  (borough ? "<br>" + borough : "");
                layer.bindPopup(label);
              },
            }).addTo(map);

            // After the polygons load, call callback (to color them)
            if (callback) {
              callback();
            }
          });
      }

      // 4. Call Flask API and color Manhattan zones by busyness
      function updateMap() {
        var date = document.getElementById("date").value;
        var period = document.getElementById("period").value;

        fetch(
          "/api/busyness?date=" +
            encodeURIComponent(date) +
            "&period=" +
            encodeURIComponent(period)
        )
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            // Build a lookup: LocationID -> info from API
            var byId = {};
            data.forEach(function (row) {
              byId[row.location_id] = row;
            });

            if (!zoneLayer) return;

            // Style each polygon
            zoneLayer.setStyle(function (feature) {
              var borough =
                feature.properties.borough || feature.properties.Borough;

              // Non Manhattan stays faded
              if (borough !== "Manhattan") {
                return {
                  color: "#999",
                  weight: 1,
                  fillColor: "#dddddd",
                  fillOpacity: 0.08,
                };
              }

              var locId =
                feature.properties.LocationID ||
                feature.properties.location_id;
              var info = byId[locId];
              var cat = info ? info.category : "Not Busy";

              return {
                color: "#555",
                weight: 1,
                fillColor: colorForCategory(cat),
                fillOpacity: 0.6,
              };
            });

            // Update popups with details such as amount of people, name, and how crowded
            zoneLayer.eachLayer(function (layer) {
              var locId =
                layer.feature.properties.LocationID ||
                layer.feature.properties.location_id;
              var info = byId[locId];
              var zoneName =
                layer.feature.properties.zone ||
                layer.feature.properties.Zone;
              var borough =
                layer.feature.properties.borough ||
                layer.feature.properties.Borough;

              var label = zoneName || "Location " + locId;
              if (borough) {
                label += "<br>" + borough;
              }
              if (info && borough === "Manhattan") {
                label +=
                  "<br>Category: " +
                  info.category +
                  "<br>People: " +
                  info.ridership.toFixed(0);
              } else if (borough === "Manhattan") {
                label += "<br>No data for this selection";
              }
              layer.bindPopup(label);
            });
          });
      }

      // The update button: re-color the map based on current date/period
      document
        .getElementById("updateBtn")
        .addEventListener("click", updateMap);

      // First: load polygons, then color them with the initial selection
      loadGeojson(updateMap);
    </script>
  </body>
</html>
